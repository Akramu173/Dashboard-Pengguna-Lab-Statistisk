<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Dashboard Pengguna Laboratorium Statistika</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            box-sizing: border-box;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            font-weight: 600;
            color: #004d40;
            font-size: 2.5em;
        }
        .filter-container {
            text-align: center;
            margin-bottom: 25px;
            display: flex;
            justify-content: center;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-container select, .filter-container button, .filter-container input {
            font-family: 'Poppins', sans-serif;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        .filter-container button {
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            transition: background-color 0.3s;
        }
        .filter-container button:hover {
            background-color: #0056b3;
        }
        .total-visitors-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
            margin: 20px auto;
            max-width: 300px;
        }
        .total-visitors-card h3 {
            margin: 0;
            font-size: 1.2em;
            color: #555;
        }
        .total-visitors-card p {
            font-size: 3em;
            font-weight: 600;
            color: #004d40;
            margin: 5px 0 0;
        }
        .chart-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }
        .chart-container {
            width: 30%;
            min-width: 300px;
            height: 400px;
            margin: 10px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <h1>Dashboard Pengguna Laboratorium Statistika</h1>
    
    <div class="filter-container">
        <label for="date-picker">Hari:</label>
        <input type="date" id="date-picker">
        
        <label for="month-picker">Bulan:</label>
        <input type="month" id="month-picker">

        <button id="show-total">Lihat Keseluruhan</button>
    </div>

    <div class="total-visitors-card">
        <h3>Total Pengguna</h3>
        <p id="total-users">0</p>
    </div>

    <div class="chart-row">
        <div id="chart-lab" class="chart-container"></div>
        <div id="chart-angkatan" class="chart-container"></div>
        <div id="chart-tujuan" class="chart-container"></div>
    </div>

    <script>
        const googleSheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsZulxJRVUIZaoj4GfPBsFvOwGD1h1DYfkys2yBBTIoHqwgPm9krXcJk2VeywOYHjNbBieG1Q8c4eI/pub?gid=0&single=true&output=csv';
        const customColors = [
            '#0A7F66',
            '#4DC0B5',
            '#2F7C85',
            '#0D5B7F',
            '#4F9ED1',
            '#87D2E6'
        ];

        async function fetchCsvData() {
            const response = await fetch(googleSheetCsvUrl);
            const text = await response.text();
            return text.split('\n').map(row => row.split(',').map(cell => cell.trim()));
        }

        async function createPieChart(containerId, title, columnIndex, mode, filterValue = null, allDataRows) {
            const dataStartIndex = 1;
            let filteredData = allDataRows.slice(dataStartIndex);
            
            if (mode === 'daily' && filterValue) {
                filteredData = filteredData.filter(row => {
                    const rowDate = new Date(row[0]).toLocaleDateString('id-ID');
                    const sDate = new Date(filterValue).toLocaleDateString('id-ID');
                    return rowDate === sDate;
                });
            } else if (mode === 'monthly' && filterValue) {
                const [year, month] = filterValue.split('-');
                filteredData = filteredData.filter(row => {
                    const rowDate = new Date(row[0]);
                    return rowDate.getFullYear() == year && (rowDate.getMonth() + 1) == month;
                });
            }
            
            const columnData = filteredData.map(row => row[columnIndex]);
            const dataCounts = {};
            columnData.forEach(item => {
                if (item) {
                    dataCounts[item] = (dataCounts[item] || 0) + 1;
                }
            });

            const seriesData = Object.keys(dataCounts).map(name => ({
                name: name,
                value: dataCounts[name]
            }));

            const chartDom = document.getElementById(containerId);
            if (echarts.getInstanceByDom(chartDom)) {
                echarts.getInstanceByDom(chartDom).dispose();
            }
            const myChart = echarts.init(chartDom);
            
            const option = {
                color: customColors, 
                title: {
                    text: title + (mode === 'daily' ? ` (${filterValue})` : mode === 'monthly' ? ` (${filterValue})` : ' (Total)'),
                    left: 'center',
                    top: '20px',
                    textStyle: {
                        fontFamily: 'Poppins',
                        fontSize: 16
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b} : {c} ({d}%)',
                    textStyle: {
                        fontFamily: 'Poppins'
                    }
                },
                legend: {
                    orient: 'horizontal',
                    bottom: 'bottom',
                    data: Object.keys(dataCounts),
                    textStyle: {
                        fontFamily: 'Poppins',
                        fontSize: 12
                    }
                },
                series: [
                    {
                        name: 'Jumlah Pengguna',
                        type: 'pie',
                        radius: '55%', 
                        center: ['50%', '55%'],
                        data: seriesData,
                        label: {
                            show: true,
                            formatter: '{b}', // Hanya menampilkan nama data
                            fontSize: 12
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }
                ]
            };
            myChart.setOption(option);
            window.addEventListener('resize', () => myChart.resize());
        }

        async function initDashboard() {
            const datePicker = document.getElementById('date-picker');
            const monthPicker = document.getElementById('month-picker');
            const showTotalBtn = document.getElementById('show-total');
            const totalUsersEl = document.getElementById('total-users');

            function calculateTotalUsers(mode, filterValue, allData) {
                let filteredData = allData.slice(1);
                if (mode === 'daily' && filterValue) {
                     filteredData = filteredData.filter(row => {
                        const rowDate = new Date(row[0]).toLocaleDateString('id-ID');
                        const sDate = new Date(filterValue).toLocaleDateString('id-ID');
                        return rowDate === sDate;
                    });
                } else if (mode === 'monthly' && filterValue) {
                    const [year, month] = filterValue.split('-');
                    filteredData = filteredData.filter(row => {
                        const rowDate = new Date(row[0]);
                        return rowDate.getFullYear() == year && (rowDate.getMonth() + 1) == month;
                    });
                }
                return filteredData.length;
            }

            function loadCharts(mode, filterValue = null) {
                fetchCsvData().then(allData => {
                    const totalUsers = calculateTotalUsers(mode, filterValue, allData);
                    totalUsersEl.textContent = totalUsers;
                    
                    createPieChart('chart-lab', 'Berdasarkan Laboratorium', 1, mode, filterValue, allData);
                    createPieChart('chart-angkatan', 'Berdasarkan Angkatan', 4, mode, filterValue, allData);
                    createPieChart('chart-tujuan', 'Berdasarkan Tujuan', 5, mode, filterValue, allData);
                });
            }

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayDateStr = `${year}-${month}-${day}`;
            datePicker.value = todayDateStr;
            loadCharts('daily', todayDateStr);

            datePicker.addEventListener('change', (event) => {
                const newDate = event.target.value;
                monthPicker.value = '';
                loadCharts('daily', newDate);
            });
            
            monthPicker.addEventListener('change', (event) => {
                const newMonth = event.target.value;
                datePicker.value = '';
                if (newMonth) {
                    loadCharts('monthly', newMonth);
                }
            });

            showTotalBtn.addEventListener('click', () => {
                datePicker.value = '';
                monthPicker.value = '';
                loadCharts('total');
            });
            
            setInterval(() => {
                console.log("Memperbarui data secara otomatis...");
                const currentMode = (datePicker.value) ? 'daily' : (monthPicker.value) ? 'monthly' : 'total';
                const currentValue = (datePicker.value) ? datePicker.value : monthPicker.value;
                loadCharts(currentMode, currentValue);
            }, 60000);
        }

        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>